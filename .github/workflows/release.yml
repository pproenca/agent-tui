name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.2.0)'
        required: true
        type: string
      ref:
        description: 'Git ref to release (defaults to refs/tags/v<version>)'
        required: false
        type: string
      dry_run:
        description: 'Dry run (skip publishing)'
        required: false
        type: boolean
        default: false

concurrency:
  group: release-${{ github.event_name == 'workflow_dispatch' && inputs.version || github.ref }}
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag_name: ${{ steps.version.outputs.tag_name }}
      dry_run: ${{ steps.version.outputs.dry_run }}
      prerelease: ${{ steps.version.outputs.prerelease }}
      run_id: ${{ steps.ci-run.outputs.run_id }}
      head_sha: ${{ steps.sha.outputs.head_sha }}

    steps:
      - name: Resolve release ref
        id: resolve
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            REF_INPUT="${{ inputs.ref }}"
            if [ -z "$REF_INPUT" ]; then
              REF_INPUT="refs/tags/v${{ inputs.version }}"
            fi
            echo "ref=$REF_INPUT" >> "$GITHUB_OUTPUT"
            echo "dry_run=${{ inputs.dry_run }}" >> "$GITHUB_OUTPUT"
          else
            echo "ref=${{ github.ref }}" >> "$GITHUB_OUTPUT"
            echo "dry_run=false" >> "$GITHUB_OUTPUT"
          fi

      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.resolve.outputs.ref }}
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup bun
        uses: oven-sh/setup-bun@v1

      - name: Resolve head SHA
        id: sha
        run: |
          echo "head_sha=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"

      - name: Resolve CI run
        id: ci-run
        uses: actions/github-script@v7
        with:
          script: |
            const headSha = '${{ steps.sha.outputs.head_sha }}';
            const ref = '${{ steps.resolve.outputs.ref }}';
            const tagName = ref.startsWith('refs/tags/') ? ref.slice('refs/tags/'.length) : null;
            const { owner, repo } = context.repo;
            const maxAttempts = 20;
            const delayMs = 30000;
            let match = null;
            let matchArtifacts = null;

            const requiredArtifacts = [
              'agent-tui-linux-x64',
              'agent-tui-linux-arm64',
              'agent-tui-linux-x64-musl',
              'agent-tui-linux-arm64-musl',
              'agent-tui-darwin-x64',
              'agent-tui-darwin-arm64',
            ];

            const hasAllArtifacts = (names) =>
              requiredArtifacts.every((name) => names.includes(name));

            const preferredRun = (run) =>
              tagName && run.head_branch === tagName ? 1 : 0;

            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner,
                repo,
                workflow_id: 'ci.yml',
                per_page: 100,
              });

              const candidates = runs.data.workflow_runs
                .filter(
                  (run) =>
                    run.head_sha === headSha &&
                    run.conclusion === 'success' &&
                    run.event !== 'pull_request',
                )
                .sort((a, b) => {
                  const pref = preferredRun(b) - preferredRun(a);
                  if (pref !== 0) return pref;
                  return new Date(b.created_at) - new Date(a.created_at);
                });

              for (const run of candidates) {
                const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
                  owner,
                  repo,
                  run_id: run.id,
                  per_page: 100,
                });
                const names = artifacts.data.artifacts.map((artifact) => artifact.name);
                core.info(`CI run ${run.id} artifacts: ${names.join(', ') || 'none'}`);
                if (hasAllArtifacts(names)) {
                  match = run;
                  matchArtifacts = names;
                  break;
                }
              }

              if (match) {
                break;
              }

              const inProgress = runs.data.workflow_runs.find(run =>
                run.head_sha === headSha && run.status !== 'completed'
              );

              if (!inProgress || attempt === maxAttempts) {
                break;
              }

              core.info(`Waiting for CI run for ${headSha}... (attempt ${attempt}/${maxAttempts})`);
              await new Promise(resolve => setTimeout(resolve, delayMs));
            }

            if (!match) {
              core.setFailed(
                `No successful CI run found for ${headSha} with required release artifacts. Ensure CI completed on the release tag.`,
              );
              return;
            }

            core.info(`Selected CI run ${match.id} with artifacts: ${matchArtifacts.join(', ')}`);
            core.setOutput('run_id', match.id.toString());

      - name: Validate versions
        id: version
        working-directory: cli
        run: |
          set -euo pipefail
          bun scripts/xtask.ts version check --quiet
          VERSION=$(bun scripts/xtask.ts version current)

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            INPUT_VERSION="${{ inputs.version }}"
            echo "Input version: $INPUT_VERSION"

            TAG_NAME="v$INPUT_VERSION"
            if ! git tag --points-at HEAD --list "$TAG_NAME" | grep -q "$TAG_NAME"; then
              echo "::error::Tag $TAG_NAME does not point at the selected ref"
              exit 1
            fi

            bun scripts/xtask.ts version assert-tag "$TAG_NAME"
            DRY_RUN="${{ steps.resolve.outputs.dry_run }}"
          else
            TAG_NAME="${GITHUB_REF#refs/tags/}"
            echo "Git tag version: $TAG_NAME"

            bun scripts/xtask.ts version assert-tag "$TAG_NAME"

            DRY_RUN="${{ steps.resolve.outputs.dry_run }}"
          fi

          if [[ "$VERSION" == *-* ]]; then
            PRERELEASE=true
          else
            PRERELEASE=false
          fi

          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag_name=$TAG_NAME" >> "$GITHUB_OUTPUT"
          echo "dry_run=$DRY_RUN" >> "$GITHUB_OUTPUT"
          echo "prerelease=$PRERELEASE" >> "$GITHUB_OUTPUT"
          echo "All versions match: $VERSION"

  release:
    name: Create GitHub Release
    needs: [validate]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
      id-token: write
      attestations: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate.outputs.head_sha }}
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup bun
        uses: oven-sh/setup-bun@v1

      - name: Download Linux release artifacts
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ needs.validate.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: cli/artifacts
          pattern: agent-tui-linux-*
          if-no-files-found: error

      - name: Download macOS release artifacts
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ needs.validate.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: cli/artifacts
          pattern: agent-tui-darwin-*
          if-no-files-found: error

      - name: Verify release artifacts
        working-directory: cli
        run: bun scripts/xtask.ts dist verify --input artifacts --kind release

      - name: Prepare release assets
        working-directory: cli
        run: bun scripts/xtask.ts dist release --input artifacts --output release

      - name: Generate build provenance attestation
        if: needs.validate.outputs.dry_run != 'true'
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: cli/release/agent-tui-*

      - name: Create Release
        if: needs.validate.outputs.dry_run != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.validate.outputs.tag_name }}
          files: cli/release/*
          generate_release_notes: true
          draft: false
          prerelease: ${{ needs.validate.outputs.prerelease == 'true' }}

      - name: Dry run summary
        if: needs.validate.outputs.dry_run == 'true'
        working-directory: cli
        run: |
          echo "## Dry Run Summary" >> $GITHUB_STEP_SUMMARY
          echo "Would have released version: ${{ needs.validate.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts:" >> $GITHUB_STEP_SUMMARY
          ls -la release/ >> $GITHUB_STEP_SUMMARY

  publish-npm:
    name: Publish to npm
    needs: [release, validate, publish-validate]
    if: needs.validate.outputs.dry_run != 'true' && needs.publish-validate.outputs.npm_skip != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate.outputs.head_sha }}
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup bun
        uses: oven-sh/setup-bun@v1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ needs.validate.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: cli/artifacts

      - name: Verify npm artifacts
        working-directory: cli
        run: bun scripts/xtask.ts dist verify --input artifacts --kind npm

      - name: Prepare npm package
        working-directory: cli
        run: bun scripts/xtask.ts dist npm --input artifacts --output bin

      - name: Publish to npm with provenance
        working-directory: cli
        run: npm publish --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  publish-validate:
    name: Publish Dry Runs
    needs: [release, validate]
    if: needs.validate.outputs.dry_run != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
      id-token: write
    outputs:
      npm_skip: ${{ steps.npm-check.outputs.skip }}

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate.outputs.head_sha }}
          fetch-depth: 0

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Setup bun
        uses: oven-sh/setup-bun@v1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ needs.validate.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: cli/artifacts

      - name: Verify npm artifacts
        working-directory: cli
        run: bun scripts/xtask.ts dist verify --input artifacts --kind npm

      - name: Prepare npm package
        working-directory: cli
        run: bun scripts/xtask.ts dist npm --input artifacts --output bin

      - name: Check if version already published (npm)
        id: npm-check
        working-directory: cli
        run: |
          VERSION=$(node -p "require('./package.json').version")
          if npm view agent-tui@$VERSION version 2>/dev/null; then
            echo "Version $VERSION already published to npm"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Verify npm package (dry-run)
        if: steps.npm-check.outputs.skip != 'true'
        working-directory: cli
        run: npm publish --access public --dry-run
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
