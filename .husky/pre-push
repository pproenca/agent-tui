#!/bin/sh
set -e

printf '%s\n' "Running pre-push checks..."

printf '\n→ Checking formatting...\n'
cargo fmt --all --check

printf '\n→ Building workspace...\n'
cargo build --workspace

printf '\n→ Running clippy...\n'
cargo clippy --workspace --all-targets -- -D warnings

printf '\n→ Running ast-grep Clean Architecture checks...\n'
if command -v ast-grep >/dev/null 2>&1; then
  ast_output=$(ast-grep scan --config sgconfig.yml 2>&1) || true
  if printf '%s' "${ast_output}" | grep -q "^error\["; then
    printf '%s\n' "${ast_output}"
    printf '\nERROR: ast-grep found Clean Architecture violations!\n'
    exit 1
  fi
else
  printf 'ast-grep not installed, skipping...\n'
fi

printf '\n→ Running tests...\n'
cargo test --workspace

printf '\n→ Checking for unused dependencies...\n'
cargo machete

printf '\nAll pre-push checks passed!\n'
