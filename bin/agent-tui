#!/bin/sh
# agent-tui entry point
# Finds and executes the correct platform binary

set -e

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

# Detect platform and architecture
detect_platform() {
    OS="$(uname -s)"
    ARCH="$(uname -m)"

    case "$OS" in
        Linux)
            PLATFORM="linux"
            ;;
        Darwin)
            PLATFORM="darwin"
            ;;
        MINGW*|MSYS*|CYGWIN*|Windows_NT)
            PLATFORM="win32"
            ;;
        *)
            echo "Unsupported platform: $OS" >&2
            exit 1
            ;;
    esac

    case "$ARCH" in
        x86_64|amd64)
            ARCH="x64"
            ;;
        arm64|aarch64)
            ARCH="arm64"
            ;;
        *)
            echo "Unsupported architecture: $ARCH" >&2
            exit 1
            ;;
    esac

    echo "${PLATFORM}-${ARCH}"
}

PLATFORM_ARCH="$(detect_platform)"
BINARY_NAME="agent-tui-${PLATFORM_ARCH}"

# Add .exe extension on Windows
case "$PLATFORM_ARCH" in
    win32-*)
        BINARY_NAME="${BINARY_NAME}.exe"
        ;;
esac

BINARY_PATH="${SCRIPT_DIR}/${BINARY_NAME}"

# Check if the binary exists
if [ ! -f "$BINARY_PATH" ]; then
    echo "Binary not found: $BINARY_PATH" >&2
    echo "Please run 'npm install' to download the binary for your platform." >&2
    echo "Or install via: cargo install agent-tui" >&2
    exit 1
fi

# Make sure it's executable (no-op on Windows)
chmod +x "$BINARY_PATH" 2>/dev/null || true

# Execute the binary with all arguments
exec "$BINARY_PATH" "$@"
