#!/usr/bin/env node

const { spawnSync } = require('child_process');
const fs = require('fs');
const path = require('path');
const { resolveBinaryPath } = require('../scripts/platform');

function main() {
  const resolved = resolveBinaryPath();

  if (!resolved.platformArch) {
    console.error(`Unsupported platform: ${process.platform}-${process.arch}`);
    console.error('You can build from source: cargo install --git https://github.com/pproenca/agent-tui.git --path cli/crates/agent-tui');
    process.exit(1);
  }

  if (!resolved.binPath || !fs.existsSync(resolved.binPath)) {
    const target = resolved.binPath ? path.relative(process.cwd(), resolved.binPath) : resolved.pkgName;
    console.error(`Binary not found for ${resolved.platformArch}: ${target}`);
    console.error('Reinstall the package to ensure the platform binary is present.');
    process.exit(1);
  }

  const result = spawnSync(resolved.binPath, process.argv.slice(2), { stdio: 'inherit' });

  if (result.error) {
    console.error(`Failed to launch agent-tui: ${result.error.message}`);
    process.exit(1);
  }

  process.exit(result.status ?? 0);
}

main();
