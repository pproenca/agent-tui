id: event-driven
language: rust
severity: warning
message: "Avoid std::thread::sleep in async contexts; use tokio::time::sleep or spawn_blocking."
note: |
  Blocking sleeps halt the async runtime thread and can starve other tasks.
  Use tokio::time::sleep for async delays, or spawn_blocking for blocking work.

  Guidance:
  - If the call runs on an async runtime thread, replace with tokio::time::sleep.
  - If you must block, move the work into spawn_blocking and document why.
  - If it only appears in tests or one-off tooling, consider a narrow, documented exception.
rule:
  any:
    - all:
        - pattern: std::thread::sleep($$$)
        - inside:
            kind: function_item
            has:
              kind: function_modifiers
              regex: "async"
              stopBy: end
            stopBy: end
    - all:
        - pattern: thread::sleep($$$)
        - inside:
            kind: function_item
            has:
              kind: function_modifiers
              regex: "async"
              stopBy: end
            stopBy: end
    - all:
        - pattern: std::thread::sleep($$$)
        - inside:
            pattern: async { $$$ }
            stopBy: end
    - all:
        - pattern: thread::sleep($$$)
        - inside:
            pattern: async { $$$ }
            stopBy: end
    - all:
        - pattern: std::thread::sleep($$$)
        - inside:
            pattern: async move { $$$ }
            stopBy: end
    - all:
        - pattern: thread::sleep($$$)
        - inside:
            pattern: async move { $$$ }
            stopBy: end
    - all:
        - pattern: std::thread::sleep($$$)
        - inside:
            pattern: async |$$$| { $$$ }
            stopBy: end
    - all:
        - pattern: thread::sleep($$$)
        - inside:
            pattern: async |$$$| { $$$ }
            stopBy: end
    - all:
        - pattern: std::thread::sleep($$$)
        - inside:
            pattern: async move |$$$| { $$$ }
            stopBy: end
    - all:
        - pattern: thread::sleep($$$)
        - inside:
            pattern: async move |$$$| { $$$ }
            stopBy: end
  not:
    any:
      - inside:
          pattern: tokio::task::spawn_blocking($$$)
          stopBy: end
      - inside:
          pattern: tokio::spawn_blocking($$$)
          stopBy: end
