# Dockerfile.build - Cross-compilation container for agent-tui
#
# This Dockerfile builds Linux binaries for both x64 and arm64 architectures.
# Used by docker-compose.yml for local cross-compilation testing.

ARG RUST_VERSION=1.75
ARG TARGET=x86_64-unknown-linux-gnu

FROM rust:${RUST_VERSION}-slim-bookworm AS builder

ARG TARGET

# Install build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    pkg-config \
    musl-tools \
    && rm -rf /var/lib/apt/lists/*

# Install cross-compilation toolchains based on target
RUN case "${TARGET}" in \
    "x86_64-unknown-linux-gnu") \
        apt-get update && apt-get install -y --no-install-recommends \
            gcc-x86-64-linux-gnu \
        && rm -rf /var/lib/apt/lists/* \
        ;; \
    "aarch64-unknown-linux-gnu") \
        apt-get update && apt-get install -y --no-install-recommends \
            gcc-aarch64-linux-gnu \
        && rm -rf /var/lib/apt/lists/* \
        ;; \
    esac

# Add the target
RUN rustup target add ${TARGET}

# Set up cargo config for cross-compilation
RUN mkdir -p /root/.cargo && \
    echo '[target.aarch64-unknown-linux-gnu]' >> /root/.cargo/config.toml && \
    echo 'linker = "aarch64-linux-gnu-gcc"' >> /root/.cargo/config.toml && \
    echo '' >> /root/.cargo/config.toml && \
    echo '[target.x86_64-unknown-linux-gnu]' >> /root/.cargo/config.toml && \
    echo 'linker = "x86_64-linux-gnu-gcc"' >> /root/.cargo/config.toml

WORKDIR /build

# Copy the source code
COPY cli/ ./cli/
COPY Cargo.lock ./

# Build the binary
RUN cd cli && cargo build --release --target ${TARGET}

# Copy the binary to a predictable location
RUN mkdir -p /output && \
    cp /build/cli/target/${TARGET}/release/agent-tui /output/agent-tui

# Final stage - just the binary
FROM scratch AS export
COPY --from=builder /output/agent-tui /agent-tui
